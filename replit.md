# Overview

RECOV. is a full-stack TypeScript business management application designed to streamline operations and enhance productivity for businesses. It offers modules for managing leads, quotations, proforma invoices, invoices, receipts, and customer debts. Key capabilities include dashboard analytics, bulk operations via Excel uploads, professional document generation, robust user and role-based access control, secure authentication, and duplicate detection for master data.

# User Preferences

Preferred communication style: Simple, everyday language.

# System Architecture

## UI/UX Decisions
The application utilizes `shadcn/ui` (Radix UI) and Tailwind CSS for a responsive design, custom theming, and dark mode adaptation. Skeleton loaders improve the user experience during data fetching, prioritizing clarity and ease of use for CRM tasks.

## Technical Implementations
*   **Frontend**: React with TypeScript, Vite, TanStack Query for server state, Wouter for routing, React Hook Form with Zod for form handling, and Recharts for data visualization.
*   **Backend**: Express.js with TypeScript, featuring an interface-based storage design and a RESTful API with Zod schema validation. Multer handles Excel file processing.
*   **Data Storage**: Drizzle ORM configured for PostgreSQL, with Zod schemas ensuring data integrity for core entities like Customers, Payments, Roles, and Users.
*   **Authentication**: Secure email/password login with bcrypt hashing, session-based authentication, protected routes, and email-based password reset functionality.
*   **Production Optimizations**: Environment-aware seeding process that skips heavy tenant role updates in production to prevent startup timeouts and ensure fast deployment. PostgreSQL session store properly configured for both development and published (REPLIT_DEPLOYMENT=1) environments, ensuring WebSocket authentication persistence and preventing error 4500.
*   **API Request Pattern**: Custom `apiRequest` utility in `client/src/lib/queryClient.ts` with signature `apiRequest(method, url, data)` for all HTTP mutations. Corrected systematic parameter order issue across 13 locations in telecmi-config, telecmi-call-button, daily-targets, call-queue, tasks, communication-schedules, and notification-center components (November 2025).

## Feature Specifications
*   **Analytics Dashboard**: Provides real-time statistics, financial overviews, and recent activity.
*   **Debtors Module**: Calculates outstanding balances.
*   **Invoice Module**: Features auto-calculated Final G.P., FIFO receipt allocation, and period-based interest calculation with detailed UI and A4 print format.
*   **Proforma Invoice Module**: Full CRUD operations with grid features, enforcing one PI per quotation.
*   **Enhanced Import System**: Universal editable import preview for various modules with inline error correction, smart parsing, and duplicate detection.
*   **User Management & RBAC**: Includes module-specific permissions (View, Create, Edit, Delete, Export, Import, Print), field-level access control (e.g., hiding Gross Profit), action button permissions, dashboard card access, user-specific column preferences, smart redirect logic, automatic Admin role provisioning, and a protected Admin user system to prevent lockout. **NEW: Subscription-Based Role Management** - Roles page now enforces subscription plan boundaries with frontend filtering (hides unavailable modules), backend validation (rejects out-of-plan permissions with upgrade messaging), user assignment count display, and protected Admin role deletion (prevents deletion of last Admin role or roles with assigned users). **NEW: Admin Role Protection System (November 2025)** - When platform admin assigns subscription plans, tenant's Admin role automatically receives ALL permissions (View/Create/Edit/Delete/Export/Import/Print) for subscribed modules, ALL dashboard cards (28 cards), and ALL action permissions (GP access, Email, WhatsApp, SMS, Call, Reminder, Share). Admin role permissions are fully protected with frontend UI disabling all controls (checkboxes, switches, buttons) with tooltips explaining protection, backend API validation rejecting modification attempts with 403 errors, atomic transaction handling ensuring tenant + Admin role updates together, and real-time WebSocket broadcasts for immediate permission updates across active sessions.
*   **Credit Control & Recovery System**: Features cumulative grace period logic, partial payment thresholds, auto/manual category modes with audit logging, configurable follow-up rules, and advanced follow-up automation settings for multi-channel communication (WhatsApp/Email/IVR).
*   **Communication Integrations**:
    *   **Email**: Nodemailer integration supporting Gmail OAuth2/SMTP, advanced template management with 35+ variables across 11 modules, a visual variable picker, professional HTML templates, server-side variable enrichment with complex financial calculations, absolute URL generation, and a 2-column editor layout. **NEW: Extended Email Templates** - Email template system expanded from 8 to 11 modules (added Ledger, Interest Calculator, Customer Reports) with server-side enrichment for computed fields (ledger balances, transaction counts, interest calculations, aging analysis). EmailDialog component fully integrated with backend enrichment pipeline, passing templateId and module type for proper variable substitution across all business documents.
    *   **WhatsApp**: Enterprise-grade messaging via multi-provider support with message templates and automatic data enrichment.
    *   **Ringg.ai AI Calling**: AI-powered voice calling with script mapping, call triggering, history, and webhook integration.
    *   **Telecmi PIOPIY Voice Calling (Production-Ready)**: Multi-provider voice calling system with AES-256-GCM encrypted credential storage, intelligent template suggestion engine, and unified call history. Features 12 professionally-toned call templates (4 escalation levels Ã— 3 languages: Hindi/English/Hinglish) auto-seeded for all 66 tenants (792 total templates). Smart template auto-selection based on days overdue with clamping logic to prevent premature escalation. Supports both Simple TTS and AI Conversation modes. Reusable TelecmiCallButton component integrated in Invoice and Debtors modules with language switching, script preview, and manual template override. HMAC-based webhook authentication for answered/missed/CDR events. **NEW: Automatic Phone Number Normalization** - Intelligent phone number normalization with automatic +91 country code prefix for Indian numbers, ensuring proper Nation Capacity routing (Error 480 "capacity not available" fix - November 2025). **NEW: Template Variable Substitution** - Full variable substitution in call scripts with actual values: {{customerName}} replaced with customer's actual name, {{companyName}} with tenant's businessName from database, {{invoiceNumber}} and {{amount}} with real invoice data. Backend enriches callContext with tenant data before passing to buildScript function (November 2025). Backend routes: `/api/telecmi/make-call` (POST), `/api/call-templates/:module` (GET), `/api/telecmi/webhook-secret` (GET). Configuration page in Followup Automation settings with webhook secret display and credential management. Call logs unified with Ringg.ai in single table (provider column distinguishes sources).
*   **Communication Schedules (Dual-Mode Scheduling System - November 2025)**: Comprehensive automated communication scheduling supporting both specific datetime and invoice due-date-based triggers. Features dual scheduling modes: (1) **Specific DateTime** - schedule communications for exact date/time (e.g., Dec 25 10:00 AM), (2) **Due-Date Based** - dynamic scheduling relative to invoice due dates (X days before/after due, including zero-offset for same-day reminders). Supports multi-channel communication (Email/WhatsApp/Telecmi IVR calls) with template selection, multi-category filtering (Alpha/Beta/Gamma/Delta), and backward-compatible filter parsing (supports both new pipe-delimited and legacy SQL-style formats). Background scheduler service runs every 5 minutes via setInterval-based architecture (no external dependencies), enforces daily cadence for due-date triggers, handles zero-offset schedules correctly, and includes comprehensive error handling with informative logging. Edit functionality preserves all selected categories and zero-offset values using nullish coalescing. Manual trigger endpoint available at POST `/api/schedules/:id/trigger` for testing. Production-ready with full backward compatibility for existing schedules.
*   **Tenant Credential Emails**: Automated sending of login credentials to newly approved tenants.
*   **Customer Ledger Module**: Provides a complete transaction history view with debits and credits, running balance, pastel color-coded voucher types, PDF generation, and sharing capabilities.
*   **Daily Engagement Features (Action Center & Team Performance)**: Includes a daily dashboard, task manager, call queue, universal activity log, leaderboard, daily targets, and a real-time notification center with role-based access control.
*   **Subscription Plans Management (Multi-Tenant SaaS)**: Comprehensive subscription-based multi-tenant system with module-level access control. Features predefined and customizable plans (Starter/Professional/Enterprise), a plan management UI, tenant plan assignment, a module propagation system, strict subscription-based sidebar filtering (tenants see ONLY their plan's modules), subscription-specific permission generation (eliminates unnecessary permissions), automatic migration for existing tenants, and real-time analytics. **NEW: Real-Time Subscription Updates** - When platform admin assigns/updates subscription plans, changes apply immediately using atomic database transactions (tenant + Admin role updates guaranteed together), WebSocket-based real-time notifications to affected users, automatic frontend refresh of permissions and modules without page reload, graceful degradation on failures, and comprehensive error logging for production monitoring.
*   **Whisper Voice AI (Production-Ready MVP)**: OpenAI Whisper-powered voice transcription with multi-language support (Hindi/English/Hinglish), credit-based usage system (300/1000/3000 min per plan tier), addon purchase capability, and intelligent command parsing. Features browser-based audio recording via MediaRecorder API, file upload validation (25MB limit, audio MIME types), real-time transcription display, automatic language detection, and deterministic regex-based command extraction for "create lead/quotation/customer/invoice" voice commands. Backend implements pre-flight credit validation (prevents burning OpenAI credits on insufficient balance), atomic credit deduction via SELECT FOR UPDATE transactions, sanitized error responses (no API detail leakage), encrypted OpenAI API key storage, and comprehensive usage logging. Frontend provides loading state management to prevent transient "no credits" errors during initial data fetch. All 64 existing tenants migrated with Whisper module enabled and tiered credit allocations.
*   **Telegram Bot Business Intelligence (November 2025 - Foundation MVP)**: Voice-based business intelligence bot for multi-tenant SaaS with strict tenant isolation via one-time linking codes. Features single Telegram bot serving all tenants (cost-effective webhook-based architecture), platform admin configuration page (/telegram-bot-settings) for bot token management and connection testing, tenant portal (/telegram-link) for user linking with 24-hour expiring codes, and comprehensive user management (link/unlink, activity tracking). Bot command handlers: /start (welcome and onboarding), /link CODE (one-time linking with validation), /help (usage instructions in Hindi/English/Hinglish). Voice message processing with OpenAI Whisper API transcription (downloads OGG from Telegram, auto-detects Hindi/English/Hinglish). Database schema includes 4 tables: telegram_bot_config (bot configuration), telegram_user_mappings (user-to-tenant mapping with activity tracking), telegram_linking_codes (24-hour expiring codes with usage tracking), telegram_query_logs (audit trail for all queries). Security features: tenant isolation enforced at bot handler level, linking code expiry and one-time-use validation, encrypted bot token storage, proper authentication middleware for all API endpoints. Backend routes: POST /api/telegram/webhook (receives Telegram updates), GET/POST /api/telegram/config (bot configuration CRUD), POST /api/telegram/test (connection test), POST /api/telegram/generate-link-code (code generation), GET /api/telegram/link-codes (fetch codes), GET /api/telegram/linked-users (fetch mappings), DELETE /api/telegram/linked-users/:id (unlink user). Foundation complete with bot handlers and voice transcription working. Business intelligence query processing (natural language intent detection, data queries for invoices/debtors/revenue/customers, formatted responses with emojis/tables) planned for future implementation.

# External Dependencies

*   **Database**: PostgreSQL via Neon serverless driver (`@neondatabase/serverless`).
*   **Session Management**: `connect-pg-simple`.
*   **File Processing**: `XLSX`, `Multer`.
*   **Frontend Libraries**: `date-fns`, `lucide-react`, `class-variance-authority`, `clsx`, `wouter`, `recharts`.
*   **Authentication**: `bcrypt`, `express-session`.
*   **Email Service**: `nodemailer`.
*   **Voice AI**: OpenAI Whisper API (`openai` npm package).
*   **Voice Calling**: Telecmi PIOPIY SDK (`piopiy` npm package).
*   **Telegram Bot**: Telegraf framework (`telegraf` npm package), form-data for file uploads.