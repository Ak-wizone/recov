// Category column - FIXED
{
  accessorKey: "category",
  header: "CATEGORY",
  cell: ({ row }) => {
    const autoUpgradeEnabled = recoverySettings?.autoUpgradeEnabled ?? false;
    return (
      <div onClick={(e) => e.stopPropagation()}>
        <Select
          value={row.original.category}
          onValueChange={(value) => {
            if (autoUpgradeEnabled) {
              toast({
                title: "Auto-Upgrade Enabled",
                description: "Category changes are automatic. Disable auto-upgrade in Category Rules to manually change categories.",
                variant: "destructive",
              });
              return;
            }
            updateFieldMutation.mutate({
              id: row.original.id,
              field: "category",
              value: value,
            });
          }}
          disabled={autoUpgradeEnabled}
        >
          <SelectTrigger
            className={`h-8 w-32 ${categoryColors[row.original.category as keyof typeof categoryColors]} ${autoUpgradeEnabled ? 'opacity-60 cursor-not-allowed' : ''}`}
            data-testid={`select-category-${row.original.id}`}
          >
            <SelectValue>{row.original.category}</SelectValue>
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="Alpha">Alpha</SelectItem>
            <SelectItem value="Beta">Beta</SelectItem>
            <SelectItem value="Gamma">Gamma</SelectItem>
            <SelectItem value="Delta">Delta</SelectItem>
          </SelectContent>
        </Select>
      </div>
    );
  },
  enableSorting: true,
  enableHiding: false,
},

// Interest Applicable From column - FIXED
{
  accessorKey: "interestApplicableFrom",
  header: "INTEREST APPLICABLE FROM",
  cell: ({ row }) => (
    <div onClick={(e) => e.stopPropagation()}>
      <Select
        value={row.original.interestApplicableFrom || ""}
        onValueChange={(value) => {
          updateFieldMutation.mutate({
            id: row.original.id,
            field: "interestApplicableFrom",
            value: value,
          });
        }}
      >
        <SelectTrigger
          className="h-8 w-36"
          data-testid={`select-interestApplicableFrom-${row.original.id}`}
        >
          <SelectValue placeholder="Select">
            {row.original.interestApplicableFrom || "â€”"}
          </SelectValue>
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="Invoice Date">Invoice Date</SelectItem>
          <SelectItem value="Due Date">Due Date</SelectItem>
        </SelectContent>
      </Select>
    </div>
  ),
  enableSorting: true,
},

// Sales Person column - FIXED
{
  accessorKey: "salesPerson",
  header: "SALES PERSON",
  cell: ({ row }) => {
    const salesPersons = getSalesPersons();
    return (
      <div onClick={(e) => e.stopPropagation()}>
        <Select
          value={row.original.salesPerson || ""}
          onValueChange={(value) => {
            updateFieldMutation.mutate({
              id: row.original.id,
              field: "salesPerson",
              value: value,
            });
          }}
        >
          <SelectTrigger
            className="h-8 w-40 bg-gray-800 dark:bg-gray-700 text-white border-gray-600"
            data-testid={`select-salesPerson-${row.original.id}`}
          >
            <SelectValue placeholder="Select person">
              {row.original.salesPerson || "Select person"}
            </SelectValue>
          </SelectTrigger>
          <SelectContent className="z-50">
            {salesPersons.map((person) => (
              <SelectItem key={person} value={person}>
                {person}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>
    );
  },
  enableSorting: true,
},

// Status column - FIXED
{
  accessorKey: "isActive",
  header: "STATUS",
  cell: ({ row }) => (
    <div onClick={(e) => e.stopPropagation()}>
      <Select
        value={row.original.isActive}
        onValueChange={(value) => {
          updateFieldMutation.mutate({
            id: row.original.id,
            field: "isActive",
            value: value,
          });
        }}
      >
        <SelectTrigger
          className={`h-8 w-32 ${statusColors[row.original.isActive as keyof typeof statusColors]}`}
          data-testid={`select-status-${row.original.id}`}
        >
          <SelectValue>{row.original.isActive}</SelectValue>
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="Active">Active</SelectItem>
          <SelectItem value="Inactive">Inactive</SelectItem>
        </SelectContent>
      </Select>
    </div>
  ),
  enableSorting: true,
},

// Actions column - FIXED
{
  id: "actions",
  header: "Actions",
  cell: ({ row }) => (
    <div className="flex gap-2" onClick={(e) => e.stopPropagation()}>
      <Button
        variant="ghost"
        size="sm"
        onClick={(e) => {
          e.stopPropagation(); // Extra safety
          setSelectedCustomer(row.original);
          setIsFormOpen(true);
        }}
        className="hover:bg-blue-50"
        data-testid={`button-edit-${row.original.id}`}
        aria-label={`Edit ${row.original.clientName}`}
      >
        <Pencil className="h-4 w-4 text-blue-600" />
      </Button>
      <Button
        variant="ghost"
        size="sm"
        onClick={(e) => {
          e.stopPropagation(); // Extra safety
          if (window.confirm(`Are you sure you want to delete ${row.original.clientName}?`)) {
            deleteMutation.mutate(row.original.id);
          }
        }}
        className="hover:bg-red-50"
        data-testid={`button-delete-${row.original.id}`}
        aria-label={`Delete ${row.original.clientName}`}
      >
        <Trash2 className="h-4 w-4 text-red-600" />
      </Button>
    </div>
  ),
  enableSorting: false,
  enableHiding: false,
}