<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Categorization - Accounting App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .config-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .config-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: 5px;
        }

        .config-item label {
            font-weight: 500;
            color: #555;
        }

        .config-item input {
            width: 80px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .category-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .badge-alpha {
            background: #d4edda;
            color: #155724;
        }

        .badge-beta {
            background: #fff3cd;
            color: #856404;
        }

        .badge-gamma {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-delta {
            background: #d6d8db;
            color: #1b1e21;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close-btn {
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .log-entry {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .log-time {
            color: #999;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .log-details {
            color: #555;
            font-size: 14px;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-section select,
        .filter-section input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            .modal-content {
                width: 95%;
                margin: 20px auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè¢ Customer Categorization System</h1>
            <p>Customers ko payment behavior aur follow-up ke basis par categorize karein</p>
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('dashboard')">üìä Dashboard</button>
                <button class="tab-btn" onclick="showTab('customers')">üë• Customers</button>
                <button class="tab-btn" onclick="showTab('invoices')">üìÑ Invoices</button>
                <button class="tab-btn" onclick="showTab('followups')">üìû Follow-ups</button>
                <button class="tab-btn" onclick="showTab('config')">‚öôÔ∏è Configuration</button>
                <button class="tab-btn" onclick="showTab('logs')">üìã Change Logs</button>
            </div>
        </header>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="stat-alpha">0</h3>
                    <p>Alpha Customers</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-beta">0</h3>
                    <p>Beta Customers</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-gamma">0</h3>
                    <p>Gamma Customers</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-delta">0</h3>
                    <p>Delta Customers</p>
                </div>
            </div>

            <div class="section">
                <h2>Recent Category Changes</h2>
                <div id="recent-changes"></div>
            </div>
        </div>

        <!-- Customers Tab -->
        <div id="customers" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Customer List</h2>
                    <button class="btn btn-primary" onclick="showAddCustomerModal()">+ Add Customer</button>
                </div>

                <div class="filter-section">
                    <label>Filter by Category:</label>
                    <select id="customer-filter" onchange="filterCustomers()">
                        <option value="all">All Categories</option>
                        <option value="alpha">Alpha</option>
                        <option value="beta">Beta</option>
                        <option value="gamma">Gamma</option>
                        <option value="delta">Delta</option>
                    </select>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Customer Name</th>
                            <th>Category</th>
                            <th>Avg Payment Delay</th>
                            <th>Total Follow-ups</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customers-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Invoices Tab -->
        <div id="invoices" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Invoices</h2>
                    <button class="btn btn-primary" onclick="showAddInvoiceModal()">+ Add Invoice</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Due Date</th>
                            <th>Payment Date</th>
                            <th>Days Overdue</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoices-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Follow-ups Tab -->
        <div id="followups" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Follow-up Records</h2>
                    <button class="btn btn-primary" onclick="showAddFollowupModal()">+ Add Follow-up</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Invoice #</th>
                            <th>Follow-up Type</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="followups-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Configuration Tab -->
        <div id="config" class="tab-content">
            <div class="alert alert-info">
                ‚ö†Ô∏è <strong>Note:</strong> Configuration change karne par sabhi customers ki category automatically recalculate ho jayegi.
            </div>

            <div class="config-grid">
                <div class="config-card">
                    <h3>üí∞ Payment Delay Thresholds</h3>
                    <div class="config-item">
                        <label>Alpha (On-time):</label>
                        <div>
                            <input type="number" id="payment-alpha" value="0" disabled> days
                        </div>
                    </div>
                    <div class="config-item">
                        <label>Beta:</label>
                        <div>
                            <input type="number" id="payment-beta" value="15"> days
                        </div>
                    </div>
                    <div class="config-item">
                        <label>Gamma:</label>
                        <div>
                            <input type="number" id="payment-gamma" value="45"> days
                        </div>
                    </div>
                    <div class="config-item">
                        <label>Delta:</label>
                        <div>
                            <input type="number" id="payment-delta" value="100"> days
                        </div>
                    </div>
                </div>

                <div class="config-card">
                    <h3>üìû Follow-up Count Thresholds</h3>
                    <div class="config-item">
                        <label>Alpha:</label>
                        <div>
                            <input type="number" id="followup-alpha" value="0" disabled> follow-ups
                        </div>
                    </div>
                    <div class="config-item">
                        <label>Beta:</label>
                        <div>
                            <input type="number" id="followup-beta" value="4"> follow-ups
                        </div>
                    </div>
                    <div class="config-item">
                        <label>Gamma:</label>
                        <div>
                            <input type="number" id="followup-gamma" value="8"> follow-ups
                        </div>
                    </div>
                    <div class="config-item">
                        <label>Delta:</label>
                        <div>
                            <input type="number" id="followup-delta" value="12"> follow-ups
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 30px; text-align: center;">
                <button class="btn btn-success" onclick="saveConfiguration()">üíæ Save Configuration</button>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="logs" class="tab-content">
            <div class="section">
                <h2>Category Change Logs</h2>
                <div class="filter-section">
                    <label>Filter by Customer:</label>
                    <select id="log-customer-filter" onchange="filterLogs()">
                        <option value="all">All Customers</option>
                    </select>
                    <label>Filter by Reason:</label>
                    <select id="log-reason-filter" onchange="filterLogs()">
                        <option value="all">All Reasons</option>
                        <option value="payment_behavior">Payment Behavior</option>
                        <option value="followup_count">Follow-up Count</option>
                        <option value="config_change">Configuration Change</option>
                    </select>
                </div>
                <div id="logs-container"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Customer Modal -->
    <div id="addCustomerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Customer</h2>
                <span class="close-btn" onclick="closeModal('addCustomerModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>Customer Name *</label>
                <input type="text" id="new-customer-name" placeholder="Enter customer name">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="new-customer-email" placeholder="Enter email">
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="text" id="new-customer-phone" placeholder="Enter phone">
            </div>
            <button class="btn btn-success" onclick="addCustomer()">Add Customer</button>
        </div>
    </div>

    <!-- Add Invoice Modal -->
    <div id="addInvoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Invoice</h2>
                <span class="close-btn" onclick="closeModal('addInvoiceModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>Customer *</label>
                <select id="invoice-customer-id"></select>
            </div>
            <div class="form-group">
                <label>Invoice Number *</label>
                <input type="text" id="invoice-number" placeholder="INV-001">
            </div>
            <div class="form-group">
                <label>Amount *</label>
                <input type="number" id="invoice-amount" placeholder="10000">
            </div>
            <div class="form-group">
                <label>Due Date *</label>
                <input type="date" id="invoice-due-date">
            </div>
            <button class="btn btn-success" onclick="addInvoice()">Add Invoice</button>
        </div>
    </div>

    <!-- Add Follow-up Modal -->
    <div id="addFollowupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Follow-up</h2>
                <span class="close-btn" onclick="closeModal('addFollowupModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>Customer *</label>
                <select id="followup-customer-id" onchange="loadPendingInvoices()"></select>
            </div>
            <div class="form-group">
                <label>Invoice *</label>
                <select id="followup-invoice-id"></select>
            </div>
            <div class="form-group">
                <label>Follow-up Type *</label>
                <select id="followup-type">
                    <option value="phone">Phone Call</option>
                    <option value="email">Email</option>
                    <option value="whatsapp">WhatsApp</option>
                    <option value="visit">Physical Visit</option>
                </select>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="followup-notes" rows="3" placeholder="Follow-up ke baare mein notes..."></textarea>
            </div>
            <button class="btn btn-success" onclick="addFollowup()">Add Follow-up</button>
        </div>
    </div>

    <!-- Mark Paid Modal -->
    <div id="markPaidModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Mark Invoice as Paid</h2>
                <span class="close-btn" onclick="closeModal('markPaidModal')">&times;</span>
            </div>
            <input type="hidden" id="paid-invoice-id">
            <div class="form-group">
                <label>Payment Date *</label>
                <input type="date" id="payment-date">
            </div>
            <button class="btn btn-success" onclick="markInvoicePaid()">Mark as Paid</button>
        </div>
    </div>

    <script>
        // Data Storage
        let config = {
            payment: {
                alpha: 0,
                beta: 15,
                gamma: 45,
                delta: 100
            },
            followup: {
                alpha: 0,
                beta: 4,
                gamma: 8,
                delta: 12
            }
        };

        let customers = [];
        let invoices = [];
        let followups = [];
        let categoryLogs = [];

        // Initialize App
        function initApp() {
            loadData();
            loadConfiguration();
            updateDashboard();
            renderCustomers();
            renderInvoices();
            renderFollowups();
            renderLogs();
            populateCustomerDropdowns();
        }

        // Load data from localStorage
        function loadData() {
            const savedConfig = localStorage.getItem('categorization_config');
            const savedCustomers = localStorage.getItem('customers');
            const savedInvoices = localStorage.getItem('invoices');
            const savedFollowups = localStorage.getItem('followups');
            const savedLogs = localStorage.getItem('category_logs');

            if (savedConfig) config = JSON.parse(savedConfig);
            if (savedCustomers) customers = JSON.parse(savedCustomers);
            if (savedInvoices) invoices = JSON.parse(savedInvoices);
            if (savedFollowups) followups = JSON.parse(savedFollowups);
            if (savedLogs) categoryLogs = JSON.parse(savedLogs);

            // Sample data agar empty ho
            if (customers.length === 0) {
                addSampleData();
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('categorization_config', JSON.stringify(config));
            localStorage.setItem('customers', JSON.stringify(customers));
            localStorage.setItem('invoices', JSON.stringify(invoices));
            localStorage.setItem('followups', JSON.stringify(followups));
            localStorage.setItem('category_logs', JSON.stringify(categoryLogs));
        }

        // Add sample data
        function addSampleData() {
            customers = [
                { id: 1, name: 'Raj Enterprises', email: 'raj@example.com', phone: '9876543210', category: 'alpha', categoryUpdatedAt: new Date().toISOString() },
                { id: 2, name: 'Sharma Trading Co', email: 'sharma@example.com', phone: '9876543211', category: 'beta', categoryUpdatedAt: new Date().toISOString() },
                { id: 3, name: 'Kumar Industries', email: 'kumar@example.com', phone: '9876543212', category: 'gamma', categoryUpdatedAt: new Date().toISOString() },
                { id: 4, name: 'Singh & Sons', email: 'singh@example.com', phone: '9876543213', category: 'delta', categoryUpdatedAt: new Date().toISOString() }
            ];

            const today = new Date();
            invoices = [
                { id: 1, customerId: 1, invoiceNumber: 'INV-001', amount: 50000, dueDate: new Date(today.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], paymentDate: new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], status: 'paid' },
                { id: 2, customerId: 2, invoiceNumber: 'INV-002', amount: 75000, dueDate: new Date(today.getTime() - 20 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], paymentDate: new Date(today.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], status: 'paid' },
                { id: 3, customerId: 3, invoiceNumber: 'INV-003', amount: 100000, dueDate: new Date(today.getTime() - 50 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], paymentDate: null, status: 'overdue' },
                { id: 4, customerId: 4, invoiceNumber: 'INV-004', amount: 150000, dueDate: new Date(today.getTime() - 120 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], paymentDate: null, status: 'overdue' }
            ];

            followups = [
                { id: 1, customerId: 3, invoiceId: 3, followupType: 'phone', notes: 'Customer ne kaha 2 din mein payment karenge', date: new Date().toISOString() },
                { id: 2, customerId: 4, invoiceId: 4, followupType: 'email', notes: 'Reminder email sent', date: new Date().toISOString() }
            ];

            saveData();
            recalculateAllCategories();
        }

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'customers') renderCustomers();
            if (tabName === 'invoices') renderInvoices();
            if (tabName === 'followups') renderFollowups();
            if (tabName === 'logs') renderLogs();
        }

        // Configuration Management
        function loadConfiguration() {
            document.getElementById('payment-beta').value = config.payment.beta;
            document.getElementById('payment-gamma').value = config.payment.gamma;
            document.getElementById('payment-delta').value = config.payment.delta;
            document.getElementById('followup-beta').value = config.followup.beta;
            document.getElementById('followup-gamma').value = config.followup.gamma;
            document.getElementById('followup-delta').value = config.followup.delta;
        }

        function saveConfiguration() {
            const oldConfig = JSON.parse(JSON.stringify(config));

            config.payment.beta = parseInt(document.getElementById('payment-beta').value);
            config.payment.gamma = parseInt(document.getElementById('payment-gamma').value);
            config.payment.delta = parseInt(document.getElementById('payment-delta').value);
            config.followup.beta = parseInt(document.getElementById('followup-beta').value);
            config.followup.gamma = parseInt(document.getElementById('followup-gamma').value);
            config.followup.delta = parseInt(document.getElementById('followup-delta').value);

            saveData();

            // Log configuration change
            const log = {
                id: Date.now(),
                customerId: null,
                customerName: 'All Customers',
                oldCategory: null,
                newCategory: null,
                reason: 'config_change',
                details: `Configuration updated. Recalculating all categories.`,
                timestamp: new Date().toISOString()
            };
            categoryLogs.unshift(log);

            // Recalculate all categories
            recalculateAllCategories();

            alert('‚úÖ Configuration saved successfully! All customer categories recalculated.');
            updateDashboard();
        }

        // Category Calculation
        function calculatePaymentCategory(customerId) {
            const customerInvoices = invoices.filter(inv => inv.customerId === customerId && inv.paymentDate);
            
            if (customerInvoices.length === 0) return { category: 'alpha', avgDelay: 0 };

            let totalDelay = 0;
            customerInvoices.forEach(inv => {
                const dueDate = new Date(inv.dueDate);
                const paymentDate = new Date(inv.paymentDate);
                const delay = Math.floor((paymentDate - dueDate) / (1000 * 60 * 60 * 24));
                totalDelay += delay;
            });

            const avgDelay = totalDelay / customerInvoices.length;

            let category = 'alpha';
            if (avgDelay > config.payment.delta) category = 'delta';
            else if (avgDelay > config.payment.gamma) category = 'gamma';
            else if (avgDelay > config.payment.beta) category = 'beta';

            return { category, avgDelay: Math.round(avgDelay) };
        }

        function calculateFollowupCategory(customerId) {
            const pendingInvoices = invoices.filter(inv => inv.customerId === customerId && inv.status !== 'paid');
            const customerFollowups = followups.filter(f => f.customerId === customerId);

            let category = 'alpha';
            if (customerFollowups.length > config.followup.delta) category = 'delta';
            else if (customerFollowups.length > config.followup.gamma) category = 'gamma';
            else if (customerFollowups.length > config.followup.beta) category = 'beta';

            return { category, count: customerFollowups.length };
        }

        function updateCustomerCategory(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const paymentResult = calculatePaymentCategory(customerId);
            const followupResult = calculateFollowupCategory(customerId);

            const categoryPriority = { 'alpha': 1, 'beta': 2, 'gamma': 3, 'delta': 4 };
            
            let finalCategory = paymentResult.category;
            if (categoryPriority[followupResult.category] > categoryPriority[paymentResult.category]) {
                finalCategory = followupResult.category;
            }

            const oldCategory = customer.category;

            if (oldCategory !== finalCategory) {
                customer.category = finalCategory;
                customer.categoryUpdatedAt = new Date().toISOString();

                // Log the change
                const log = {
                    id: Date.now(),
                    customerId: customer.id,
                    customerName: customer.name,
                    oldCategory: oldCategory,
                    newCategory: finalCategory,
                    reason: 'payment_behavior',
                    details: `Payment delay: ${paymentResult.avgDelay} days, Follow-ups: ${followupResult.count}`,
                    timestamp: new Date().toISOString()
                };
                categoryLogs.unshift(log);

                saveData();
            }

            return { changed: oldCategory !== finalCategory, oldCategory, newCategory: finalCategory };
        }

        function recalculateAllCategories() {
            customers.forEach(customer => {
                updateCustomerCategory(customer.id);
            });
            saveData();
        }

        // Customer Management
        function showAddCustomerModal() {
            document.getElementById('addCustomerModal').style.display = 'block';
        }

        function addCustomer() {
            const name = document.getElementById('new-customer-name').value;
            const email = document.getElementById('new-customer-email').value;
            const phone = document.getElementById('new-customer-phone').value;

            if (!name) {
                alert('Please enter customer name');
                return;
            }

            const newCustomer = {
                id: Date.now(),
                name: name,
                email: email,
                phone: phone,
                category: 'alpha',
                categoryUpdatedAt: new Date().toISOString()
            };

            customers.push(newCustomer);
            saveData();
            closeModal('addCustomerModal');
            renderCustomers();
            populateCustomerDropdowns();
            updateDashboard();

            // Clear form
            document.getElementById('new-customer-name').value = '';
            document.getElementById('new-customer-email').value = '';
            document.getElementById('new-customer-phone').value = '';
        }

        function renderCustomers() {
            const tbody = document.getElementById('customers-table');
            const filter = document.getElementById('customer-filter').value;

            let filteredCustomers = customers;
            if (filter !== 'all') {
                filteredCustomers = customers.filter(c => c.category === filter);
            }

            tbody.innerHTML = filteredCustomers.map(customer => {
                const paymentData = calculatePaymentCategory(customer.id);
                const followupData = calculateFollowupCategory(customer.id);

                return `
                    <tr>
                        <td>${customer.id}</td>
                        <td>${customer.name}</td>
                        <td><span class="category-badge badge-${customer.category}">${customer.category}</span></td>
                        <td>${paymentData.avgDelay} days</td>
                        <td>${followupData.count}</td>
                        <td>${new Date(customer.categoryUpdatedAt).toLocaleDateString('en-IN')}</td>
                        <td>
                            <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="viewCustomerHistory(${customer.id})">View History</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterCustomers() {
            renderCustomers();
        }

        function viewCustomerHistory(customerId) {
            const customer = customers.find(c => c.id === customerId);
            const logs = categoryLogs.filter(log => log.customerId === customerId);

            alert(`Customer: ${customer.name}\nCurrent Category: ${customer.category}\n\nTotal Category Changes: ${logs.length}`);
        }

        // Invoice Management
        function showAddInvoiceModal() {
            document.getElementById('addInvoiceModal').style.display = 'block';
            populateCustomerDropdown('invoice-customer-id');
        }

        function addInvoice() {
            const customerId = parseInt(document.getElementById('invoice-customer-id').value);
            const invoiceNumber = document.getElementById('invoice-number').value;
            const amount = parseFloat(document.getElementById('invoice-amount').value);
            const dueDate = document.getElementById('invoice-due-date').value;

            if (!customerId || !invoiceNumber || !amount || !dueDate) {
                alert('Please fill all required fields');
                return;
            }

            const newInvoice = {
                id: Date.now(),
                customerId: customerId,
                invoiceNumber: invoiceNumber,
                amount: amount,
                dueDate: dueDate,
                paymentDate: null,
                status: 'pending'
            };

            invoices.push(newInvoice);
            saveData();
            closeModal('addInvoiceModal');
            renderInvoices();

            // Clear form
            document.getElementById('invoice-number').value = '';
            document.getElementById('invoice-amount').value = '';
            document.getElementById('invoice-due-date').value = '';
        }

        function renderInvoices() {
            const tbody = document.getElementById('invoices-table');

            tbody.innerHTML = invoices.map(invoice => {
                const customer = customers.find(c => c.id === invoice.customerId);
                const dueDate = new Date(invoice.dueDate);
                const today = new Date();
                const daysOverdue = invoice.paymentDate ? 
                    Math.floor((new Date(invoice.paymentDate) - dueDate) / (1000 * 60 * 60 * 24)) :
                    Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));

                return `
                    <tr>
                        <td>${invoice.invoiceNumber}</td>
                        <td>${customer ? customer.name : 'Unknown'}</td>
                        <td>‚Çπ${invoice.amount.toLocaleString('en-IN')}</td>
                        <td>${new Date(invoice.dueDate).toLocaleDateString('en-IN')}</td>
                        <td>${invoice.paymentDate ? new Date(invoice.paymentDate).toLocaleDateString('en-IN') : '-'}</td>
                        <td>${daysOverdue > 0 ? daysOverdue : 0} days</td>
                        <td><span class="category-badge ${invoice.status === 'paid' ? 'badge-alpha' : 'badge-gamma'}">${invoice.status}</span></td>
                        <td>
                            ${invoice.status !== 'paid' ? 
                                `<button class="btn btn-success" style="padding: 5px 10px; font-size: 12px;" onclick="showMarkPaidModal(${invoice.id})">Mark Paid</button>` 
                                : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showMarkPaidModal(invoiceId) {
            document.getElementById('markPaidModal').style.display = 'block';
            document.getElementById('paid-invoice-id').value = invoiceId;
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
        }

        function markInvoicePaid() {
            const invoiceId = parseInt(document.getElementById('paid-invoice-id').value);
            const paymentDate = document.getElementById('payment-date').value;

            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (invoice) {
                invoice.paymentDate = paymentDate;
                invoice.status = 'paid';

                saveData();
                updateCustomerCategory(invoice.customerId);
                closeModal('markPaidModal');
                renderInvoices();
                updateDashboard();
            }
        }

        // Follow-up Management
        function showAddFollowupModal() {
            document.getElementById('addFollowupModal').style.display = 'block';
            populateCustomerDropdown('followup-customer-id');
        }

        function loadPendingInvoices() {
            const customerId = parseInt(document.getElementById('followup-customer-id').value);
            const select = document.getElementById('followup-invoice-id');

            const pendingInvoices = invoices.filter(inv => inv.customerId === customerId && inv.status !== 'paid');

            select.innerHTML = pendingInvoices.map(inv => 
                `<option value="${inv.id}">${inv.invoiceNumber} - ‚Çπ${inv.amount}</option>`
            ).join('');
        }

        function addFollowup() {
            const customerId = parseInt(document.getElementById('followup-customer-id').value);
            const invoiceId = parseInt(document.getElementById('followup-invoice-id').value);
            const followupType = document.getElementById('followup-type').value;
            const notes = document.getElementById('followup-notes').value;

            if (!customerId || !invoiceId) {
                alert('Please select customer and invoice');
                return;
            }

            const newFollowup = {
                id: Date.now(),
                customerId: customerId,
                invoiceId: invoiceId,
                followupType: followupType,
                notes: notes,
                date: new Date().toISOString()
            };

            followups.push(newFollowup);
            saveData();
            updateCustomerCategory(customerId);
            closeModal('addFollowupModal');
            renderFollowups();
            updateDashboard();

            // Clear form
            document.getElementById('followup-notes').value = '';
        }

        function renderFollowups() {
            const tbody = document.getElementById('followups-table');

            tbody.innerHTML = followups.slice(0, 50).map(followup => {
                const customer = customers.find(c => c.id === followup.customerId);
                const invoice = invoices.find(inv => inv.id === followup.invoiceId);

                return `
                    <tr>
                        <td>${new Date(followup.date).toLocaleDateString('en-IN')}</td>
                        <td>${customer ? customer.name : 'Unknown'}</td>
                        <td>${invoice ? invoice.invoiceNumber : 'Unknown'}</td>
                        <td>${followup.followupType}</td>
                        <td>${followup.notes || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // Logs Management
        function renderLogs() {
            const container = document.getElementById('logs-container');
            const customerFilter = document.getElementById('log-customer-filter').value;
            const reasonFilter = document.getElementById('log-reason-filter').value;

            let filteredLogs = categoryLogs;

            if (customerFilter !== 'all') {
                filteredLogs = filteredLogs.filter(log => log.customerId === parseInt(customerFilter));
            }

            if (reasonFilter !== 'all') {
                filteredLogs = filteredLogs.filter(log => log.reason === reasonFilter);
            }

            if (filteredLogs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No logs found</p>';
                return;
            }

            container.innerHTML = filteredLogs.map(log => `
                <div class="log-entry">
                    <div class="log-time">${new Date(log.timestamp).toLocaleString('en-IN')}</div>
                    <div class="log-details">
                        <strong>${log.customerName || 'System'}</strong>
                        ${log.oldCategory && log.newCategory ? 
                            `<br>Category changed: <span class="category-badge badge-${log.oldCategory}">${log.oldCategory}</span> ‚Üí <span class="category-badge badge-${log.newCategory}">${log.newCategory}</span>` 
                            : ''}
                        <br>${log.details}
                    </div>
                </div>
            `).join('');

            // Populate customer filter dropdown
            const select = document.getElementById('log-customer-filter');
            const currentValue = select.value;
            select.innerHTML = '<option value="all">All Customers</option>' +
                customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            select.value = currentValue;
        }

        function filterLogs() {
            renderLogs();
        }

        // Dashboard
        function updateDashboard() {
            const stats = {
                alpha: customers.filter(c => c.category === 'alpha').length,
                beta: customers.filter(c => c.category === 'beta').length,
                gamma: customers.filter(c => c.category === 'gamma').length,
                delta: customers.filter(c => c.category === 'delta').length
            };

            document.getElementById('stat-alpha').textContent = stats.alpha;
            document.getElementById('stat-beta').textContent = stats.beta;
            document.getElementById('stat-gamma').textContent = stats.gamma;
            document.getElementById('stat-delta').textContent = stats.delta;

            // Recent changes
            const recentChanges = document.getElementById('recent-changes');
            const recentLogs = categoryLogs.slice(0, 5);

            if (recentLogs.length === 0) {
                recentChanges.innerHTML = '<p style="text-align: center; color: #999;">No recent changes</p>';
            } else {
                recentChanges.innerHTML = recentLogs.map(log => `
                    <div class="log-entry">
                        <div class="log-time">${new Date(log.timestamp).toLocaleString('en-IN')}</div>
                        <div class="log-details">
                            <strong>${log.customerName || 'System'}</strong>
                            ${log.oldCategory && log.newCategory ? 
                                `<br>Category changed: <span class="category-badge badge-${log.oldCategory}">${log.oldCategory}</span> ‚Üí <span class="category-badge badge-${log.newCategory}">${log.newCategory}</span>` 
                                : ''}
                            <br>${log.details}
                        </div>
                    </div>
                `).join('');
            }
        }

        // Utility Functions
        function populateCustomerDropdowns() {
            populateCustomerDropdown('invoice-customer-id');
            populateCustomerDropdown('followup-customer-id');
        }

        function populateCustomerDropdown(elementId) {
            const select = document.getElementById(elementId);
            select.innerHTML = customers.map(c => 
                `<option value="${c.id}">${c.name}</option>`
            ).join('');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modal on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Initialize app on load
        window.onload = initApp;
    </script>
</body>
</html>